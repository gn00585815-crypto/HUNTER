<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    canvas { 
      background: #2d5a27; 
      border: 4px solid #1a3a18; 
      display: block; 
      margin: 0 auto; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.5); 
    }
    body { background-color: #1a202c; color: white; overflow-x: hidden; }
    
    /* Boss ä¾†è¥²çš„è­¦å‘Šå‹•ç•« */
    @keyframes flash {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(1.5); }
    }
    .boss-warning {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: red;
      font-size: 3rem;
      font-weight: bold;
      text-shadow: 2px 2px 0px black;
      pointer-events: none;
      display: none;
    }
    .warning-active {
      display: block;
      animation: flash 2s ease-in-out;
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

  <div class="text-center mb-4 relative w-full max-w-md">
    <h1 class="text-4xl font-bold text-yellow-500 mb-2">ğŸ¤  çµäºº vs ç†Š ğŸ»</h1>
    <div class="flex justify-between px-4 text-xl font-mono font-bold">
        <p>åˆ†æ•¸: <span id="score" class="text-white">0</span></p>
        <p class="text-yellow-400 text-sm mt-1">ä¸‹å€‹BOSS: <span id="nextBoss">300</span></p>
    </div>
  </div>

  <div style="position: relative;">
    <canvas id="gameCanvas" width="400" height="500"></canvas>
    <div id="bossWarning" class="boss-warning">âš ï¸ BOSS ä¾†è¥²! âš ï¸</div>
  </div>

  <div class="mt-6 space-x-4 text-center">
    <div class="flex gap-4 justify-center mb-4">
        <button id="startBtn" onclick="initGame()" class="bg-green-600 hover:bg-green-700 px-8 py-2 rounded-full font-bold transition-all">é–‹å§‹çµæ•</button>
        <button onclick="navToLeaderboard()" class="bg-blue-600 hover:bg-blue-700 px-8 py-2 rounded-full font-bold transition-all">æ’è¡Œæ¦œ</button>
    </div>
    <p class="text-xs text-gray-500">æ§åˆ¶ï¼šå·¦å³ç§»å‹•ï¼Œç©ºç™½éµ/ä¸Šéµå°„æ“Š | é¦–é ˜å‡ºç¾ï¼š300åˆ†, ä¹‹å¾Œæ¯500åˆ†</p>
  </div>

  <!-- éŠæˆ²çµæŸå°è©±æ¡† -->
  <div id="saveModal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50">
    <div class="bg-white text-gray-900 p-8 rounded-xl max-w-sm w-full">
      <h2 class="text-2xl font-bold mb-2 text-center text-red-600">ç‹©çµçµæŸï¼</h2>
      <p class="mb-4 text-center">ä½ çš„åˆ†æ•¸ï¼š<span id="finalScore" class="font-bold text-green-600 text-xl"></span></p>
      <div class="mb-4">
        <label class="block text-sm font-semibold text-gray-600 mb-1">çµäººä»£è™Ÿï¼š</label>
        <input type="text" id="playerName" placeholder="ä¾‹å¦‚ï¼šæœ€å¼·çµäºº" class="w-full border-2 border-gray-300 p-2 rounded focus:border-green-500 outline-none">
      </div>
      <button onclick="submitScore()" id="submitBtn" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 transition">ä¸Šå‚³åˆ†æ•¸ (Create)</button>
      <button onclick="document.getElementById('saveModal').classList.add('hidden')" class="w-full mt-2 text-gray-400 text-sm py-1">å–æ¶ˆ</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // éŠæˆ²ç‹€æ…‹
    let gameActive = false;
    let score = 0;
    let frame = 0;
    let lastFireFrame = 0;

    // è§’è‰²ç‰©ä»¶
    let hunterX = 200;
    let bullets = [];
    let bears = [];
    
    // BOSS ç›¸é—œè®Šæ•¸
    let bossMode = false;
    // ä¿®æ”¹é» 1ï¼šåˆå§‹é–€æª»è¨­ç‚º 300
    let nextBossThreshold = 300; 
    let logs = []; // BOSS çš„æ”»æ“Š (æœ¨é ­)
    let boss = {
        x: 200,
        y: 60,
        hp: 20,
        maxHp: 20,
        width: 60,
        speed: 3,
        direction: 1, // 1:å³, -1:å·¦
        attackCooldown: 0
    };

    // éµç›¤ç›£è½
    let keys = {};
    window.addEventListener('keydown', e => keys[e.code] = true);
    window.addEventListener('keyup', e => keys[e.code] = false);

    function initGame() {
      if (gameActive) return;
      // é‡ç½®æ‰€æœ‰æ•¸å€¼
      score = 0;
      frame = 0;
      lastFireFrame = 0;
      gameActive = true;
      
      // é‡ç½®è§’è‰²èˆ‡æ•µäºº
      hunterX = 200;
      bullets = [];
      bears = [];
      logs = [];
      
      // é‡ç½® BOSS ç‹€æ…‹
      bossMode = false;
      // ä¿®æ”¹é» 2ï¼šé‡ç½®éŠæˆ²æ™‚ï¼Œç¬¬ä¸€éš» Boss è¨­ç‚º 300 åˆ†
      nextBossThreshold = 300;
      
      // UI æ›´æ–°
      document.getElementById('startBtn').innerText = "é€²è¡Œä¸­...";
      document.getElementById('startBtn').disabled = true;
      document.getElementById('score').innerText = "0";
      // ä¿®æ”¹é» 3ï¼šUI åˆå§‹é¡¯ç¤º 300
      document.getElementById('nextBoss').innerText = "300";
      document.getElementById('saveModal').classList.add('hidden');
      
      loop();
    }

    function loop() {
      if (!gameActive) return;
      update();
      draw();
      frame++;
      requestAnimationFrame(loop);
    }

    function update() {
      // 1. çµäººç§»å‹•
      if (keys['ArrowLeft'] && hunterX > 25) hunterX -= 6;
      if (keys['ArrowRight'] && hunterX < 375) hunterX += 6;
      
      // 2. çµäººå°„æ“Š
      if ((keys['Space'] || keys['ArrowUp']) && (frame - lastFireFrame > 12)) {
        bullets.push({ x: hunterX, y: 440 });
        lastFireFrame = frame;
      }

      // 3. å­å½ˆç§»å‹•
      for (let i = bullets.length - 1; i >= 0; i--) {
        bullets[i].y -= 8;
        if (bullets[i].y < 0) bullets.splice(i, 1);
      }

      // 4. éŠæˆ²é‚è¼¯åˆ†æµï¼šBOSS æ¨¡å¼ vs æ™®é€šæ¨¡å¼
      if (bossMode) {
        updateBossLogic();
      } else {
        updateNormalLogic();
      }
    }

    // --- æ™®é€šæ¨¡å¼é‚è¼¯ ---
    function updateNormalLogic() {
      // æª¢æŸ¥æ˜¯å¦è§¸ç™¼ BOSS æˆ°
      if (score >= nextBossThreshold) {
        startBossFight();
        return;
      }

      // ç”Ÿæˆå°ç†Š
      let spawnRate = Math.max(12, 45 - Math.floor(score / 60));
      if (frame % spawnRate === 0) {
        bears.push({ 
          x: Math.random() * 340 + 30, 
          y: -30,
          speed: 2 + (score / 300)
        });
      }

      // å°ç†Šç§»å‹•èˆ‡ç¢°æ’
      for (let bi = bears.length - 1; bi >= 0; bi--) {
        let bear = bears[bi];
        bear.y += bear.speed;
        
        // å¤±æ•—åˆ¤å®š
        if (bear.y > 500 || (Math.abs(bear.x - hunterX) < 25 && bear.y > 440)) {
          gameOver();
          return;
        }

        // è¢«å­å½ˆæ‰“ä¸­
        for (let ui = bullets.length - 1; ui >= 0; ui--) {
          let bullet = bullets[ui];
          if (Math.hypot(bullet.x - bear.x, bullet.y - bear.y) < 25) {
            bears.splice(bi, 1);
            bullets.splice(ui, 1);
            score += 10;
            updateScoreUI();
            break;
          }
        }
      }
    }

    // --- BOSS æ¨¡å¼é‚è¼¯ ---
    function updateBossLogic() {
        // BOSS ç§»å‹• (å·¦å³ä¾†å›)
        boss.x += boss.speed * boss.direction;
        if (boss.x > 360 || boss.x < 40) {
            boss.direction *= -1; // ç¢°åˆ°é‚Šç·£è½‰å‘
        }

        // BOSS æ”»æ“Š (ä¸Ÿæœ¨é ­)
        boss.attackCooldown--;
        // ç´„æ¯ 0.8 ~ 1.2 ç§’æ”»æ“Šä¸€æ¬¡
        if (boss.attackCooldown <= 0) {
            logs.push({ x: boss.x, y: boss.y + 30, speed: 5 });
            boss.attackCooldown = Math.random() * 30 + 30; // 30~60 å¹€å†·å»
        }

        // æœ¨é ­ç§»å‹•èˆ‡åˆ¤å®š
        for (let i = logs.length - 1; i >= 0; i--) {
            let log = logs[i];
            log.y += log.speed;
            
            // æœ¨é ­å‡ºç•Œç§»é™¤
            if (log.y > 500) logs.splice(i, 1);

            // æœ¨é ­æ‰“ä¸­çµäºº -> GAME OVER
            if (Math.abs(log.x - hunterX) < 30 && Math.abs(log.y - 465) < 30) {
                gameOver();
                return;
            }
        }

        // ç©å®¶æ”»æ“Š BOSS
        for (let i = bullets.length - 1; i >= 0; i--) {
            let b = bullets[i];
            // ç°¡å–®çŸ©å½¢ç¢°æ’ (BOSS æ¯”è¼ƒå¤§)
            if (Math.abs(b.x - boss.x) < 40 && Math.abs(b.y - boss.y) < 40) {
                boss.hp--;
                bullets.splice(i, 1); // ç§»é™¤å­å½ˆ
                
                // BOSS è¢«æ“Šæ•—
                if (boss.hp <= 0) {
                    defeatBoss();
                }
                break;
            }
        }
    }

    function startBossFight() {
        bossMode = true;
        bears = []; // æ¸…ç©ºå ´ä¸Šå°ç†Š
        
        // åˆå§‹åŒ– BOSS
        boss.hp = 20;
        boss.x = 200;
        boss.attackCooldown = 60;
        logs = [];

        // é¡¯ç¤ºè­¦å‘Š
        const warning = document.getElementById('bossWarning');
        warning.classList.add('warning-active');
        setTimeout(() => warning.classList.remove('warning-active'), 2000);
    }

    function defeatBoss() {
        bossMode = false;
        score += 100; // æ“Šæ•— BOSS çå‹µåˆ†
        // ä¿®æ”¹é» 4ï¼šæ“Šæ•—å¾Œï¼Œä¸‹ä¸€æ¬¡çš„é–€æª»å¢åŠ  500 (300 -> 800 -> 1300...)
        nextBossThreshold += 500; 
        updateScoreUI();
    }

    function updateScoreUI() {
        document.getElementById('score').innerText = score;
        document.getElementById('nextBoss').innerText = nextBossThreshold;
    }

    function draw() {
      ctx.clearRect(0, 0, 400, 500);
      
      // èƒŒæ™¯
      ctx.fillStyle = "#254d20";
      for(let i=0; i<10; i++) ctx.fillRect(i*50, (frame%100), 2, 20);

      // ç•«çµäºº
      ctx.font = "32px serif";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ğŸ¤ ", hunterX, 465);

      // ç•«ç©å®¶å­å½ˆ
      ctx.fillStyle = "#fbbf24";
      ctx.shadowBlur = 10;
      ctx.shadowColor = "yellow";
      bullets.forEach(b => {
        ctx.beginPath();
        ctx.arc(b.x, b.y, 4, 0, Math.PI * 2);
        ctx.fill();
      });
      ctx.shadowBlur = 0;

      // --- ç¹ªè£½ BOSS æ¨¡å¼å…ƒä»¶ ---
      if (bossMode) {
          // ç•« BOSS (å¤§éš»ç†Š)
          ctx.font = "60px serif";
          ctx.fillText("ğŸ»", boss.x, boss.y);
          
          // ç•«æœ¨é ­ (BOSS å­å½ˆ)
          ctx.font = "30px serif";
          logs.forEach(log => {
              ctx.fillText("ğŸªµ", log.x, log.y);
          });

          // ç•« BOSS è¡€æ¢
          drawHealthBar();

      } else {
          // ç•«æ™®é€šå°ç†Š
          ctx.font = "30px serif";
          bears.forEach(bear => {
            ctx.fillText("ğŸ»", bear.x, bear.y);
          });
      }
    }

    function drawHealthBar() {
        const barWidth = 200;
        const barHeight = 20;
        const x = (canvas.width - barWidth) / 2;
        const y = 10;
        
        // è¡€æ¢å¤–æ¡†
        ctx.strokeStyle = "white";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, barWidth, barHeight);
        
        // è¡€é‡å…§å®¹ (ç´…è‰²)
        const hpPercent = boss.hp / boss.maxHp;
        ctx.fillStyle = "red";
        ctx.fillRect(x + 2, y + 2, (barWidth - 4) * hpPercent, barHeight - 4);
        
        // æ–‡å­—æ¨™ç¤º
        ctx.fillStyle = "white";
        ctx.font = "12px sans-serif";
        ctx.fillText("BOSS HP: " + boss.hp, canvas.width/2, y + 35);
    }

    function gameOver() {
      gameActive = false;
      document.getElementById('finalScore').innerText = score;
      document.getElementById('saveModal').classList.remove('hidden');
      document.getElementById('startBtn').innerText = "é‡æ–°é–‹å§‹";
      document.getElementById('startBtn').disabled = false;
    }

    function submitScore() {
      const name = document.getElementById('playerName').value || "ç„¡åçµäºº";
      const btn = document.getElementById('submitBtn');
      if (name.trim() === "") return alert("è«‹è¼¸å…¥ä»£è™Ÿï¼");
      btn.disabled = true;
      btn.innerText = "å‚³é€ä¸­...";
      google.script.run
        .withSuccessHandler(res => {
          alert(res.message);
          document.getElementById('saveModal').classList.add('hidden');
          btn.disabled = false;
          btn.innerText = "ä¸Šå‚³åˆ†æ•¸ (Create)";
          document.getElementById('playerName').value = "";
        })
        .withFailureHandler(err => {
          alert("å„²å­˜å¤±æ•—ï¼š" + err);
          btn.disabled = false;
        })
        .createScore(name, score);
    }

    function navToLeaderboard() {
      google.script.run
        .withSuccessHandler(url => window.open(url + "?page=leaderboard", "_top"))
        .getScriptUrl();
    }
  </script>
</body>
</html>
    }
  </script>
</body>
</html>
